# Bloob Haus - Claude Code Context

**Purpose:** Share this file at the start of each Claude Code session.  
**Last Updated:** February 18, 2026
**Current Phase:** Phase 2 Active â€” graph.json API + graph visualizer complete; validation report remaining

---

## Quick Status

| Milestone | Status |
|-----------|--------|
| Phase 1: Recipe Site (Hugo) | âœ… COMPLETE |
| Hugo â†’ Eleventy Migration (M0-M7) | âœ… COMPLETE |
| Site Enhancements (RSS, sitemap, images) | âœ… COMPLETE |
| Templatized Builder (multi-site) | âœ… COMPLETE |
| Test Suite (Phase 1 + 1.5) | âœ… COMPLETE |
| GitHub Actions CI/CD | âœ… COMPLETE |
| Cloudflare Pages hosting | âœ… COMPLETE |
| DNS migration (Porkbun â†’ Cloudflare) | âœ… COMPLETE |
| Phase 2: graph.json API | âœ… COMPLETE |
| Phase 2: Graph visualizer | âœ… COMPLETE |
| Phase 2: Validation report | ğŸ”§ REMAINING |

**LIVE SITE:** https://buffbaby.bloob.haus (Buff Baby Kitchen)  
**Cloudflare URL:** https://buffbaby-f5k.pages.dev

---

## What This Project Is

Bloob Haus transforms Obsidian markdown vaults into hosted static websites using Eleventy.

**Current state:** buffbaby.bloob.haus is live with Leon's recipes from a private GitHub repo, powered by Eleventy 3.x with a templatized multi-site builder, modular visualizer architecture, backlinks, interactive link graph, RSS feed, sitemap, and optimized images. The builder supports multiple sites via YAML config + pluggable themes.

---

## What's Working

- Full preprocessing pipeline (Obsidian â†’ Eleventy-ready markdown)
- Eleventy 3.x site with warm color theme
- Auto-deployment via GitHub Actions â†’ Cloudflare Pages
- Content repo push triggers builder via `repository_dispatch`
- Custom domain with HTTPS (Cloudflare SSL)
- Git-based date tracking
- Comment stripping for privacy
- Clickable recipe cards
- Auto-generated navigation
- Interactive checkboxes with localStorage persistence
- Backlinks (static list of pages that link here, per-page)
- `/graph.json` â€” site-wide bidirectional link graph API (always generated)
- `/graph-settings.json` â€” vault-wide graph settings from `.bloob/graph.yaml`
- Interactive force-directed graph visualizer on every page (local neighborhood + full-graph modal, hover tooltip with OG image preview)
- RSS feed (`/feed.xml`)
- Sitemap (`/sitemap.xml`)
- robots.txt
- Custom 404 page
- Image optimization (WebP + JPEG at 600w/1200w, lazy loading)
- Modular visualizer architecture with auto-discovery
- Templatized builder: themes in `themes/`, site config in `sites/*.yaml`
- Config-driven builds with `--site=` flag
- Test suite: 137 tests across 11 files (Vitest), co-located visualizer tests

**Build pipeline:**
```bash
npm run build           # Full build (defaults to buffbaby)
npm run build:buffbaby  # Explicit buffbaby build
npm run dev             # Eleventy dev server with hot reload
```

**Deployment (GitHub Actions â†’ Cloudflare Pages):**
- Push to `buffbaby` repo â†’ triggers `deploy-buffbaby` workflow â†’ builds â†’ deploys to Cloudflare
- Push to `bloob-haus-webapp` repo â†’ `deploy-buffbaby` + `rebuild-all` workflows fire
- Manual: `workflow_dispatch` from GitHub Actions tab

---

## Project Structure

```
bloob-haus-webapp/
â”œâ”€â”€ .github/workflows/
â”‚   â”œâ”€â”€ deploy-buffbaby.yml      âœ… CI/CD: test â†’ build â†’ deploy buffbaby to Cloudflare
â”‚   â””â”€â”€ rebuild-all.yml          âœ… CI/CD: rebuild all sites on infrastructure changes
â”œâ”€â”€ eleventy.config.js           âœ… Eleventy configuration (ESM, reads site config)
â”œâ”€â”€ vercel.json                  â³ Legacy (remove after Vercel decommission)
â”œâ”€â”€ package.json                 âœ… Scripts and dependencies
â”‚
â”œâ”€â”€ sites/                       âœ… Per-site configuration (YAML)
â”‚   â””â”€â”€ buffbaby.yaml            âœ… Buff Baby Kitchen config
â”‚
â”œâ”€â”€ themes/                      âœ… Theme library
â”‚   â”œâ”€â”€ _base/                   âœ… Shared across all themes
â”‚   â”‚   â””â”€â”€ partials/
â”‚   â”‚       â”œâ”€â”€ head.njk         âœ… <head> with meta, OG, fonts
â”‚   â”‚       â””â”€â”€ backlinks.njk    âœ… Backlinks partial
â”‚   â””â”€â”€ warm-kitchen/            âœ… Buffbaby's theme
â”‚       â”œâ”€â”€ layouts/             âœ… base.njk, page.njk, list.njk
â”‚       â”œâ”€â”€ partials/            âœ… nav, footer, scripts, tags
â”‚       â”œâ”€â”€ pages/               âœ… Homepage, 404, feed, sitemap, tags, search
â”‚       â”‚   â””â”€â”€ sections/        âœ… Section index pages (recipes/, notes/, etc.)
â”‚       â””â”€â”€ assets/css/          âœ… main.css (warm color palette)
â”‚
â”œâ”€â”€ src/                         â† ENTIRELY GENERATED (gitignored)
â”‚   â”œâ”€â”€ _data/
â”‚   â”‚   â”œâ”€â”€ site.js              â† Generated from sites/*.yaml
â”‚   â”‚   â”œâ”€â”€ tagIndex.json        â† Generated by preprocessor
â”‚   â”‚   â””â”€â”€ eleventyComputed.js  âœ… Slugified permalinks (checked in)
â”‚   â”œâ”€â”€ _includes/               â† Assembled from themes/
â”‚   â”œâ”€â”€ assets/                  â† Assembled from themes/ + visualizer bundler
â”‚   â”œâ”€â”€ media/                   â† Images (generated by preprocessor)
â”‚   â”œâ”€â”€ graph.json               â† Site-wide link graph API (always generated)
â”‚   â”œâ”€â”€ graph-settings.json      â† Vault graph settings (from .bloob/graph.yaml)
â”‚   â”œâ”€â”€ *.njk                    â† Copied from theme pages/
â”‚   â”œâ”€â”€ recipes/*.md             â† Generated content
â”‚   â”œâ”€â”€ notes/*.md               â† Generated content
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ lib/visualizers/             â† Visualizer source packages
â”‚   â”œâ”€â”€ checkbox-tracker/        âœ… Runtime: localStorage checkbox persistence
â”‚   â”œâ”€â”€ page-preview/            âœ… Runtime: hover/click preview modal
â”‚   â””â”€â”€ graph/                   âœ… Hybrid: force-directed link graph
â”‚       â”œâ”€â”€ manifest.json        âœ… Settings schema + TODO positioning note
â”‚       â”œâ”€â”€ index.js             âœ… Build-time: ```graph fence â†’ container div
â”‚       â”œâ”€â”€ browser.js           âœ… Runtime: force-graph CDN, BFS filter, modal
â”‚       â”œâ”€â”€ styles.css           âœ… CSS variable-based styles
â”‚       â””â”€â”€ graph.test.js        âœ… Co-located tests (15 tests)
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ assemble-src.js          âœ… Assembles src/ from theme + config
â”‚   â”œâ”€â”€ build-site.js            âœ… Config-driven build orchestrator
â”‚   â”œâ”€â”€ clone-content.js         âœ… Clones private GitHub repo
â”‚   â”œâ”€â”€ preprocess-content.js    âœ… Orchestrates preprocessing (9 steps)
â”‚   â”œâ”€â”€ bundle-visualizers.js    âœ… esbuild bundler (auto-discovers)
â”‚   â”œâ”€â”€ generate-og-images.js    âœ… OG preview image generator
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ config-loader.js         âœ… YAML site config loader
â”‚       â”œâ”€â”€ config-reader.js         âœ… Reads Obsidian config
â”‚       â”œâ”€â”€ publish-filter.js        âœ… Dual-mode filtering
â”‚       â”œâ”€â”€ file-index-builder.js    âœ… Filename-based URLs
â”‚       â”œâ”€â”€ wiki-link-resolver.js    âœ… [[Links]] resolution
â”‚       â”œâ”€â”€ markdown-link-resolver.js âœ… Standard links
â”‚       â”œâ”€â”€ attachment-resolver.js   âœ… Image handling
â”‚       â”œâ”€â”€ transclusion-handler.js  âœ… ![[Embed]] placeholders
â”‚       â”œâ”€â”€ comment-stripper.js      âœ… Privacy protection
â”‚       â”œâ”€â”€ tag-extractor.js         âœ… Tag extraction & normalization
â”‚       â”œâ”€â”€ git-date-extractor.js    âœ… Last modified dates
â”‚       â”œâ”€â”€ graph-builder.js         âœ… Builds nodes+links from per-page link data
â”‚       â””â”€â”€ graph-settings-loader.js âœ… Reads .bloob/graph.yaml from vault
â”‚
â”œâ”€â”€ tests/                       âœ… Central test suite
â”‚   â”œâ”€â”€ helpers/mock-index.js    âœ… Shared mock factories
â”‚   â”œâ”€â”€ utils/                   âœ… Preprocessing unit tests (Phase 1)
â”‚   â””â”€â”€ build/                   âœ… Config/assembly tests (Phase 1.5)
â”‚
â”œâ”€â”€ vitest.config.js             âœ… Test config (discovers tests/ + lib/)
â”œâ”€â”€ content-source/              â† Cloned from GitHub (gitignored)
â”œâ”€â”€ _site/                       â† Eleventy output (gitignored)
â””â”€â”€ docs/                        âœ… Documentation
```

---

## Key Features

### URL Structure
- **Slugs from FILENAME** - Stable URLs even when titles change
- **Folder-based URLs** - `/recipes/challah/`, `/resources/guide/`
- **Slugified paths** - Spaces â†’ hyphens, lowercase (`/lists-of-favorites/`)
- **Titles from first `#` heading** - Display only, preserves formatting

### Publishing Model (Dual Mode)
| Mode | Behavior | Config |
|------|----------|--------|
| **blocklist** (Leon's) | Publish all EXCEPT `#not-for-public` | Current setup |
| **allowlist** | Only publish if `publish: true` | Alternative |

### Link Resolution
- `[[Wiki Links]]` â†’ Resolved to folder-based URLs
- `[text](file.md)` â†’ Resolved to folder-based URLs
- Broken links â†’ `<span class="broken-link">` (doesn't crash build)

### Visualizer Architecture
- Self-contained packages in `lib/visualizers/<name>/`
- Auto-discovery: add a folder â†’ auto-bundled and loaded
- Three types: `runtime` (browser-only), `build-time` (HTML transform only), `hybrid` (both)
- Pure function design: `parser(md) â†’ data`, `renderer(data) â†’ html`
- Co-located tests: each visualizer carries its own `<name>.test.js`
- See `docs/architecture/visualizers.md` for full details

### Graph API
- `/graph.json` â€” always generated at build time regardless of visualizer activation
  - `nodes: [{ id, title, section, type, image? }]` where `id` is the page URL; `image` is the OG image URL (present only when the page has one)
  - `links: [{ source, target }]` â€” bidirectional, deduplicated, anchors stripped
- `/graph-settings.json` â€” vault-wide settings from `.bloob/graph.yaml`, defaults applied
- Graph **differs from backlinks**: backlinks = incoming-only static list per page; graph.json = full bidirectional site map served as a public JSON endpoint

### Graph Hover Tooltip
- Hovering a node shows a floating card (150px) above the cursor: OG preview image (if page has one) + page title
- Implemented as `position:fixed` div on `document.body` â€” follows mouse via `mousemove` on canvas using `e.clientX/Y`
- This avoids coordinate-space issues: `graph2ScreenCoords()` returns viewport coords, not element-relative; `position:fixed` + `clientX/Y` are both viewport coords, so no math needed
- `node.image` comes from `graph.json` (written by `graph-builder.js` when page has `image` frontmatter)

### Graph Visualizer Settings (`.bloob/graph.yaml`)
```yaml
only_if_linked: true   # hide if page has no connections (default: true)
depth: 2               # local neighborhood hops (default: 2)
show_full_graph: true  # "Full graph" button for modal (default: true)
colors:                # all optional â€” inherits CSS variables by default
  node: "#d2691e"
  node_current: "#8b4513"
  link: "#e8dcc4"
  text: "#666666"
  bg: "#fffaf0"
```
Per-page override: frontmatter `graph: { depth: 1 }`. Inline positioning: ` ```graph\ndepth: 1\n``` `.

### Image Optimization
- `@11ty/eleventy-img` via `addTransform` on rendered HTML
- Generates WebP + JPEG at 600w and 1200w
- `<picture>` elements with `loading="lazy"` and `decoding="async"`
- Original 48MB â†’ ~6MB optimized

### OG Image Filename Encoding Rule
- **Disk filenames use raw characters** (`@`, spaces, etc.) â€” never `%`-encoded on disk
- **URLs use `encodeURIComponent`** â€” frontmatter `image` field stores `/og/{encoded}-og.{ext}`
- Single normalization point in `preprocess-content.js`: `decodeURIComponent` incoming path (normalize) â†’ `encodeURIComponent` for URL storage
- `generate-og-images.js` decodes frontmatter URL back to raw name before writing to disk
- Downstream consumers (templates, graph.json node `image` field) use the URL as-is; disk operations always decode first

---

## Environment Variables

```bash
# Required in .env.local (local) and Vercel dashboard (production)
GITHUB_TOKEN=ghp_xxx              # GitHub PAT with repo scope (secret, not in YAML)

# Optional overrides (these are now in sites/*.yaml)
SITE_NAME=buffbaby                # Which site config to load (default: buffbaby)
SITE_URL=https://buffbaby.bloob.haus  # Override URL from config
```

Most configuration has moved to `sites/buffbaby.yaml` (content repo, publish mode, theme, features, etc.). Only secrets remain as env vars.

---

## Build Pipeline Flow

```
1. Load site config (sites/buffbaby.yaml)
    â†“
2. Assemble src/ from theme (assemble-src.js)
    â”œâ”€ Copy themes/_base/ â†’ src/_includes/
    â”œâ”€ Copy themes/warm-kitchen/ â†’ src/_includes/, src/assets/, src/*.njk
    â””â”€ Generate src/_data/site.js from config
    â†“
3. Clone content repo (clone-content.js)
    â†“ GitHub â†’ content-source/
4. Preprocess content (preprocess-content.js)
    â”œâ”€ Strip comments (%% %% and <!-- -->)
    â”œâ”€ Filter (#not-for-public)
    â”œâ”€ Build index (filename â†’ URL)
    â”œâ”€ Resolve [[wiki-links]] and [text](file.md)  â† collects per-page outgoing links
    â”œâ”€ Resolve images â†’ /media/
    â”œâ”€ Handle transclusions
    â”œâ”€ Extract tags and git dates
    â”œâ”€ Add layout: layouts/page.njk
    â”œâ”€ Build + write src/graph.json (nodes+links, always)
    â”œâ”€ Read .bloob/graph.yaml â†’ write src/graph-settings.json
    â””â”€ Build + write src/_data/tagIndex.json
    â†“ content â†’ src/
5. Generate OG images (generate-og-images.js)
6. Bundle visualizers (bundle-visualizers.js)
    â†“ JS + CSS â†’ src/assets/
7. Eleventy build
    â”œâ”€ markdown-it + task-lists plugin
    â”œâ”€ Collections (recipes, notes, backlinks)
    â”œâ”€ Image optimization transform
    â””â”€ Visualizer transforms (build-time)
    â†“ â†’ _site/
8. Pagefind search index
    â†“
9. Deploy to Cloudflare Pages (via wrangler in GitHub Actions)
    â†“
buffbaby.bloob.haus (via Cloudflare CDN)
```

---

## Commands

```bash
# Full build pipeline (defaults to buffbaby)
npm run build
npm run build:buffbaby       # Explicit site name

# Local development (after running build once for content)
npm run dev

# Individual steps (for debugging)
node scripts/assemble-src.js --site=buffbaby   # Assemble src/ from theme
node scripts/clone-content.js
node scripts/preprocess-content.js
node scripts/bundle-visualizers.js
npx @11ty/eleventy

# Tests
npm test                 # Run all 137 tests once
npm run test:watch       # Watch mode (re-runs on file changes)

# Adding a new site (future)
# 1. Create themes/my-theme/ with layouts, partials, pages, assets
# 2. Create sites/my-site.yaml pointing to theme + content repo
# 3. SITE_NAME=my-site npm run build
```

---

## Key Technical Decisions

- **Templatized builder** â€” themes in `themes/`, site config in `sites/*.yaml`, `src/` entirely generated
- **`assemble-src.js`** â€” copies theme + base into `src/` before content preprocessing
- **Config fallback chain** â€” `sites/{name}.yaml` in builder repo; secrets stay as env vars
- **Eleventy 3.x with ESM** â€” `"type": "module"`, `export default async function`
- **`setUseGitIgnore(false)`** â€” generated content dirs are gitignored but must be processed
- **Visualizer parsers in preprocessor** â€” receive raw markdown, enabling code sharing with browser/Obsidian
- **`addTransform` for images** â€” post-render HTML modification, no preprocessor changes needed
- **Backlinks via `addCollection`** â€” reads source files from disk, not Eleventy internals
- **Feature flags in config** â€” backlinks, image optimization, search conditionally enabled per site

See `docs/implementation-plans/DECISIONS.md` for the full decision log.

---

## What to Do Next

Cloudflare + GitHub Actions migration is **COMPLETE**. Full CI/CD pipeline working.

**Remaining cleanup (after DNS propagates):**
- Verify `buffbaby.bloob.haus` serves from Cloudflare (check `cf-ray` response header)
- Clean up stale DNS records in Cloudflare (old Vercel A records, Porkbun wildcard/www CNAMEs)
- Decommission Vercel (remove vercel.json, delete Vercel project) â€” wait 24-48h

**Next priorities:**
- Phase 2 remaining: validation report (`--strict` flag for broken links, structured report)
- Test suite Phase 2 (6 more test files: file-index-builder, filters, computed, publish-filter, config-reader, git-date-extractor)
- Build marbles site (create `themes/spatial-garden/` + `sites/marbles.yaml`)
- Recipe scaling visualizer (`lib/visualizers/recipe-scaler/`)

See `docs/implementation-plans/ROADMAP.md` for the full roadmap.

---

## Documentation Map

```
docs/
â”œâ”€â”€ CLAUDE_CONTEXT.md           â† This file (quick orientation)
â”œâ”€â”€ CHANGELOG.md                â† Session history & milestones
â”‚
â”œâ”€â”€ architecture/               â† How systems work
â”‚   â”œâ”€â”€ visualizers.md          â† Read/display components
â”‚   â”œâ”€â”€ magic-machines.md       â† Write/transform AI tools
â”‚   â””â”€â”€ search.md              â† Search, tags, and Pagefind
â”‚
â””â”€â”€ implementation-plans/
    â”œâ”€â”€ ROADMAP.md              â† Phase overview & priorities
    â”œâ”€â”€ DECISIONS.md            â† Architectural decision log
    â”œâ”€â”€ IDEAS.md                â† Future ideas parking lot
    â”‚
    â”œâ”€â”€ _completed/             â† Finished plans (historical)
    â”‚   â”œâ”€â”€ phase-1-implementation-plan.md
    â”‚   â”œâ”€â”€ 2026-02-05_Migration-Checklist.md
    â”‚   â””â”€â”€ 2026-02-05_Migration-plan-from HUGO to ELEVENTY.md
    â”‚
    â””â”€â”€ phases/                 â† Active implementation plans
        â”œâ”€â”€ phase-2/             â† Phase 2 plans
        â”‚   â”œâ”€â”€ phase-2-linking-api.md
        â”‚   â”œâ”€â”€ 2026-02-03_recipe-scaling.md
        â”‚   â”œâ”€â”€ 2026-02-07_test-suite.md
        â”‚   â””â”€â”€ 2026-02-08 tag system and search implementation.md
        â””â”€â”€ phase-3/             â† Phase 3 plans (future)
            â””â”€â”€ 2026-02-08 multi index search architecture.md
```

**Naming conventions for new plans:**
- `YYYY-MM-DD_descriptive-name.md` for feature-specific plans

**External reference:** The Obsidian vault `bloobhaus-obsidian` contains the original vision docs including the Vicki engineering report.

---

## Keeping Docs Updated

When making changes, update the relevant docs:

| Change Type | Update |
|-------------|--------|
| New folder structure in codebase | Update "Project Structure" in this file |
| New/changed architecture (visualizers, magic machines, etc.) | Update `architecture/` docs |
| Implementation work on a phase | Update the plan in `phases/<phase-N>/` |
| Completed a session | Add to `CHANGELOG.md` |
| Significant technical decision | Add to `DECISIONS.md` |
| New feature idea | Add to `IDEAS.md` |
| Phase-level roadmap changes | Update `ROADMAP.md` |

---

*buffbaby.bloob.haus is LIVE on Eleventy and auto-updating!*
